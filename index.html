<!doctype html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GVF14P3028"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GVF14P3028');
</script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Potato: Lunar New Year (Night Lantern Festival)</title>
<style>
  html,body{margin:0;height:100%;background:#0b1026;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
  .wrap{height:100%;display:grid;place-items:center}
  canvas{
    background:#0b1026;
    border-radius:16px;
    box-shadow:0 18px 70px rgba(0,0,0,.25);
    touch-action:none;
  }
  .hud{
    position:fixed;left:14px;top:14px;
    background:rgba(15,18,35,.60);
    border:1px solid rgba(255,255,255,.10);
    padding:10px 12px;border-radius:14px;
    backdrop-filter:blur(10px);
    color:#f6efe2;
    min-width:260px;
  }
  .muted{opacity:.80;font-size:12px}
  small{display:block;margin-top:6px;line-height:1.2}
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;
    background:rgba(15,18,35,.60);
    border:1px solid rgba(255,255,255,.10);
    font-size:12px;
  }
  .overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.45);padding:18px}
  .card{
    width:min(900px,96vw);
    background:rgba(255,255,255,.92);
    border:1px solid rgba(0,0,0,.10);
    border-radius:18px;
    padding:14px 14px 12px;
    box-shadow:0 18px 80px rgba(0,0,0,.25);
    color:#2a1b22;
  }
  .btn{
    background:rgba(180,40,60,.92);
    border:1px solid rgba(0,0,0,.08);
    color:#fff;
    padding:10px 12px;
    border-radius:12px;
    cursor:pointer;
  }
  .btn:hover{filter:brightness(1.05)}
  .hidden{display:none !important}

  /* Mobile controls */
  #touchUI{position:fixed;inset:0;pointer-events:none}
  .pad,.btnE{pointer-events:auto;touch-action:none;user-select:none;-webkit-user-select:none}
  .pad{
    position:fixed;left:14px;bottom:14px;width:156px;height:156px;
    background:rgba(255,255,255,.78);
    border:1px solid rgba(0,0,0,.10);
    border-radius:18px;
    backdrop-filter:blur(10px);
    display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);
    gap:8px;padding:10px
  }
  .pad button{
    background:rgba(180,40,60,.12);
    border:1px solid rgba(0,0,0,.10);
    border-radius:14px;color:#2a1b22;font-size:18px
  }
  .pad button:active{background:rgba(180,40,60,.20)}
  .btnE{
    position:fixed;right:14px;bottom:22px;width:120px;height:64px;
    background:rgba(180,40,60,.92);
    border:1px solid rgba(0,0,0,.08);
    border-radius:18px;
    backdrop-filter:blur(10px);
    color:#fff;font-size:16px
  }
  .btnE:active{filter:brightness(1.05)}
</style>
</head>
<body>
<div class="wrap"><canvas id="c"></canvas></div>

<div class="hud">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <div><b>Lantern Night Festival</b></div>
    <div class="pill" id="actPill">Act: Festival</div>
  </div>
  <div class="muted" id="status">Walk to the center stage and press Talk (E) to start the Lion Dance.</div>
  <small>
    Keyboard: <b>WASD/Arrows</b> ¬∑ Talk: <b>E</b><br/>
    Mobile: D-pad + <b>Talk</b>
  </small>
</div>

<div class="overlay" id="loading">
  <div class="card">
    <h2 style="margin:0 0 8px">Night festival time üèÆ‚ú®</h2>
    <div class="muted" style="margin-bottom:10px">Tap Start to enable sound on mobile.</div>
    <div style="display:flex;justify-content:flex-end;gap:10px">
      <button class="btn" id="startBtn">Start</button>
    </div>
  </div>
</div>

<div id="touchUI">
  <div class="pad" id="pad">
    <div></div><button data-dir="up">‚ñ≤</button><div></div>
    <button data-dir="left">‚óÄ</button><div></div><button data-dir="right">‚ñ∂</button>
    <div></div><button data-dir="down">‚ñº</button><div></div>
  </div>
  <button class="btnE" id="btnE">Talk</button>
</div>

<!-- Envelope overlay (image) -->
<div id="envelopeOverlay" class="hidden" style="
  position:fixed; inset:0; background:rgba(0,0,0,.70);
  display:flex; align-items:center; justify-content:center;
  z-index:999; overflow:hidden;">
  <div id="envelopeCard" style="
    transform:scale(.6) rotate(-8deg);
    transition:transform .5s cubic-bezier(.2,1.5,.4,1);
    text-align:center;">
    <img src="firehorse.png" alt="Fire Horse" style="
      max-width:80vw; max-height:80vh;
      border-radius:18px; box-shadow:0 30px 90px rgba(0,0,0,.6);">
    <div style="margin-top:10px;color:#fff;font-size:14px;opacity:.85">
      Press Talk (E) to close üßß
    </div>
  </div>
</div>

<!-- Optional: your own song (put festival.mp3 next to index.html) -->
<audio id="bgMusic" src="festival.mp3" loop preload="auto"></audio>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", { alpha:false });

  // slightly less zoomed than the previous rescue file
  const ZOOM = 1.0;
  let started = false;

  function resize(){
    const vw = window.innerWidth, vh = window.innerHeight;
    const targetW = Math.min(1100, vw - 20);
    const targetH = Math.min(680, vh - 20);
    canvas.width  = Math.floor(targetW * devicePixelRatio);
    canvas.height = Math.floor(targetH * devicePixelRatio);
    canvas.style.width  = Math.floor(targetW) + "px";
    canvas.style.height = Math.floor(targetH) + "px";
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    ctx.imageSmoothingEnabled = true;
  }
  window.addEventListener("resize", resize);
  window.addEventListener("orientationchange", ()=>setTimeout(resize,150));
  resize();

  // stop scroll while playing
  document.addEventListener("touchmove", (e)=>{ if(started) e.preventDefault(); }, {passive:false});

  // HUD safe setters
  const statusEl = document.getElementById("status");
  const actPill  = document.getElementById("actPill");
  const setStatus = (t)=>{ if(statusEl) statusEl.textContent = t; };
  const setAct = (t)=>{ if(actPill) actPill.textContent = t; };

  // music helper (Safari-safe)
  function startBackgroundMusic(){
    const music = document.getElementById("bgMusic");
    if(!music) return;
    music.volume = 0.6;
    const p = music.play();
    if(p && typeof p.catch === "function") p.catch(()=>{});
  }

  // World
  const world = { w: 1200, h: 720 };
  const cam = { x:0, y:0 };
  const yardTop = Math.floor(world.h * 0.56);
  const fenceY  = Math.floor(world.h * 0.54);
  const stage = { x: world.w/2, y: Math.floor(world.h*0.76), r: 90 };

  // Player
  const player = { x: world.w/2 - 260, y: stage.y + 90, spd: 190, walk: 0 };

  // Act state
  const act = { phase:"free", t:0 };
  const lion = { x: stage.x, y: stage.y, visible:true };
  const choco = { x: stage.x, y: stage.y, yOff:0, visible:false };
  const dragon = { x:-260, y: 170, vx: 420, visible:false, carrying:false };

// Sky-flight silhouette (dragon + üç´ flying into the distance)
const skyFlight = { active:false, t:0, x:0, y:0, vx:0, vy:0, scale:1 };


  // Envelope drop
  const droppedEnvelope = { active:false, landed:false, x:0,y:0, vx:0,vy:0, rot:0, vr:0 };
  let envelopeOpen = false;

  // RNG utils
  function rnd(a,b){ return a+Math.random()*(b-a); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
  function dist(ax,ay,bx,by){ return Math.hypot(ax-bx, ay-by); }

  // Crowd (villagers + zodiac)
  const crowd = [];
  const colors = ["#3b6ea5","#6a3b8c","#2f7a45","#b43a4a","#7a4f2a","#2f506a"];
  for(let i=0;i<18;i++){
    crowd.push({
      kind:"person",
      x:rnd(140, world.w-140),
      y:rnd(yardTop+30, world.h-120),
      vx:0, vy:0,
      t:rnd(0,6.28),
      wait:rnd(0.4,1.8),
      col: colors[i%colors.length],
      seed: Math.floor(Math.random()*9999)
    });
  }
  const zodiacKinds = ["rat","ox","tiger","rabbit","dragon","snake","horse","goat","monkey","rooster","dog","pig"];
  for(let i=0;i<12;i++){
    crowd.push({
      kind:zodiacKinds[i],
      x:rnd(160, world.w-160),
      y:rnd(yardTop+40, world.h-130),
      vx:0, vy:0,
      t:rnd(0,6.28),
      wait:rnd(0.4,1.6),
      seed: Math.floor(Math.random()*9999)
    });
  }

  // Particles
  const fireworks = [];
  const confetti = [];

  // lightweight SFX
  let audioCtx = null, master = null;
  function initSfx(){
    if(audioCtx) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return;
    audioCtx = new AC();
    master = audioCtx.createGain();
    master.gain.value = 0.20;
    master.connect(audioCtx.destination);
  }
  function tone(freq, dur, type, vol){
    if(!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type || "triangle";
    o.frequency.value = freq;
    o.connect(g); g.connect(master);
    const t0 = audioCtx.currentTime;
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(vol||0.05, t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+(dur||0.12));
    o.start();
    o.stop(t0+(dur||0.12)+0.02);
  }
  function sfxPop(){ tone(880,0.08,"triangle",0.06); }
  function sfxCheer(){ tone(660,0.12,"triangle",0.05); setTimeout(()=>tone(880,0.10,"triangle",0.04), 80); }

  function spawnFirework(x,y){
    for(let i=0;i<26;i++){
      const a = Math.random()*Math.PI*2;
      const sp = rnd(90,220);
      fireworks.push({
        x,y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp,
        life:rnd(0.8,1.4),
        col:["rgba(255,80,120,.95)","rgba(255,200,60,.95)","rgba(80,200,255,.95)","rgba(120,255,160,.95)"][i%4]
      });
    }
    sfxPop();
  }
  function burstConfetti(x,y){
    for(let i=0;i<90;i++){
      confetti.push({ x,y, vx:rnd(-220,220), vy:rnd(-260,-80), life:rnd(1.2,2.2),
        col:["rgba(255,80,120,.9)","rgba(255,200,60,.9)","rgba(80,200,255,.9)","rgba(120,255,160,.9)"][i%4]
      });
    }
    sfxCheer();
  }

  function spawnDroppedEnvelope(x,y){
    droppedEnvelope.active=true;
    droppedEnvelope.landed=false;
    droppedEnvelope.x=x; droppedEnvelope.y=y;
    droppedEnvelope.vx=rnd(-60,60);
    droppedEnvelope.vy=rnd(-40,20);
    droppedEnvelope.rot=rnd(-0.6,0.6);
    droppedEnvelope.vr=rnd(-4,4);
  }
  function updateDroppedEnvelope(dt){
    if(!droppedEnvelope.active) return;
    droppedEnvelope.vy += 520*dt;
    droppedEnvelope.x += droppedEnvelope.vx*dt;
    droppedEnvelope.y += droppedEnvelope.vy*dt;
    droppedEnvelope.rot += droppedEnvelope.vr*dt;

    const groundY = world.h - 95;
    if(droppedEnvelope.y >= groundY){
      droppedEnvelope.y = groundY;
      droppedEnvelope.vy *= -0.25;
      droppedEnvelope.vx *= 0.70;
      droppedEnvelope.vr *= 0.55;
      if(Math.abs(droppedEnvelope.vy) < 40){
        droppedEnvelope.vy=0; droppedEnvelope.vx=0; droppedEnvelope.vr=0;
        droppedEnvelope.landed=true;
      }
    }
  }

  // Envelope overlay open/close (close with Talk)
  function openEnvelopeImage(){
    const overlay = document.getElementById("envelopeOverlay");
    const card = document.getElementById("envelopeCard");
    if(!overlay || !card) return;
    overlay.classList.remove("hidden");
    envelopeOpen = true;
    setTimeout(()=>{ card.style.transform = "scale(1) rotate(0deg)"; }, 50);
    spawnFirework(player.x, player.y - 60);
  }
  function closeEnvelopeImage(){
    const overlay = document.getElementById("envelopeOverlay");
    const card = document.getElementById("envelopeCard");
    if(!overlay || !card) return;
    card.style.transform = "scale(.6) rotate(8deg)";
    setTimeout(()=>{
      overlay.classList.add("hidden");
      envelopeOpen = false;
    }, 260);
  }

  // Speech bubble
  const bubble = { on:false, who:"", full:"", reveal:0, cps:18, ttl:0, done:false };
  function say(who, text, ttl=6.8, cps=18){
    bubble.on=true; bubble.who=who; bubble.full=String(text);
    bubble.reveal=0; bubble.cps=cps; bubble.ttl=ttl; bubble.done=false;
  }
  function finishBubble(){
    if(bubble.on && !bubble.done){
      bubble.reveal=bubble.full.length; bubble.done=true;
    }
  }

  // Input
  const keys = {};
  window.addEventListener("keydown",(e)=>{
    keys[e.key.toLowerCase()] = true;
    if(!started){ initSfx(); startBackgroundMusic(); start(); return; }
    if(e.key.toLowerCase()==="e") interact();
  });
  window.addEventListener("keyup",(e)=> keys[e.key.toLowerCase()] = false);

  // Mobile d-pad
  let touchDir={dx:0,dy:0}, touchHeld=false;
  function bindHold(btn,dir){
    const startHold=(ev)=>{
      ev.preventDefault();
      if(!started){ initSfx(); startBackgroundMusic(); start(); return; }
      touchHeld=true; touchDir={dx:0,dy:0};
      if(dir==="up") touchDir.dy=-1;
      if(dir==="down") touchDir.dy=1;
      if(dir==="left") touchDir.dx=-1;
      if(dir==="right") touchDir.dx=1;
    };
    const endHold=(ev)=>{ ev.preventDefault(); touchHeld=false; touchDir={dx:0,dy:0}; };
    btn.addEventListener("pointerdown",startHold);
    btn.addEventListener("pointerup",endHold);
    btn.addEventListener("pointercancel",endHold);
    btn.addEventListener("pointerleave",endHold);
    btn.addEventListener("touchstart",startHold,{passive:false});
    btn.addEventListener("touchend",endHold,{passive:false});
  }
  const pad = document.getElementById("pad");
  if(pad) pad.querySelectorAll("button[data-dir]").forEach(b=>bindHold(b, b.getAttribute("data-dir")));

  const btnE = document.getElementById("btnE");
  btnE.addEventListener("pointerdown",(ev)=>{
    ev.preventDefault();
    if(!started){ initSfx(); startBackgroundMusic(); start(); return; }
    interact();
  });
  btnE.addEventListener("touchstart",(ev)=>{
    ev.preventDefault();
    if(!started){ initSfx(); startBackgroundMusic(); start(); return; }
    interact();
  },{passive:false});

  function desiredDir(){
    let dx=0,dy=0;
    if(keys["arrowleft"]||keys["a"]) dx=-1;
    if(keys["arrowright"]||keys["d"]) dx=1;
    if(keys["arrowup"]||keys["w"]) dy=-1;
    if(keys["arrowdown"]||keys["s"]) dy=1;
    if(touchHeld){ dx=touchDir.dx; dy=touchDir.dy; }
    return {dx,dy};
  }

  function interact(){
    // Close envelope overlay with Talk
    if(envelopeOpen){ closeEnvelopeImage(); return; }

    if(bubble.on && !bubble.done && bubble.reveal < bubble.full.length){ finishBubble(); return; }

    // open envelope if nearby (allow even while falling)
    if(droppedEnvelope.active && dist(player.x,player.y, droppedEnvelope.x, droppedEnvelope.y) < 56){
      openEnvelopeImage();
      return;
    }

    // start lion dance
    if(act.phase==="free" && dist(player.x,player.y, stage.x,stage.y) < stage.r+24){
      startLionDance();
      return;
    }

    // replay if finale and near stage
    if(act.phase==="finale" && dist(player.x,player.y, stage.x,stage.y) < stage.r+34){
      resetShow(); startLionDance(); return;
    }

    if(act.phase==="free"){
      say("Festival","Night lanterns glow! Drums, snacks, and chaos. üèÆ",6.8,16);
    } else if(act.phase==="dragon"){
      say("Festival","DRAGON DELIVERY SERVICE!!",4.5,18);
    }
  }

  function resetShow(){
    act.phase="free"; act.t=0;
    setAct("Act: Festival");
    setStatus("Walk to the center stage and press Talk (E) to start the Lion Dance.");
    lion.visible=true;
    choco.visible=false; choco.yOff=0;
    dragon.visible=false; dragon.carrying=false; dragon.x=-260; dragon.y=170;
    fireworks.length=0; confetti.length=0;
    droppedEnvelope.active=false; droppedEnvelope.landed=false;
    skyFlight.active=false; skyFlight.t=0;
  }

  function startLionDance(){
    act.phase="lion"; act.t=0;
    setAct("Act: Lion Dance");
    setStatus("Lion Dance begins! Watch the center!");
    say("Drums","DUM‚ÄîDUM‚ÄîDUM! ü•Å",3.0,16);
    burstConfetti(stage.x, stage.y+40);
    spawnFirework(stage.x+120, 120);
    setTimeout(()=>spawnFirework(stage.x-160, 150), 400);
    setTimeout(()=>spawnFirework(stage.x+40, 110), 800);
  }

  // Drawing helpers
  function roundRect(x,y,w,h,r,fill,stroke){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
    if(fill){ ctx.fillStyle=fill; ctx.fill(); }
    if(stroke){ ctx.strokeStyle=stroke; ctx.lineWidth=1; ctx.stroke(); }
  }

  
  // NIGHT background (screen space)
  function drawBackground(t){
    const w=canvas.clientWidth, h=canvas.clientHeight;

    // deep night sky
    const sky=ctx.createLinearGradient(0,0,0,h);
    sky.addColorStop(0,"#0b1026");
    sky.addColorStop(0.38,"#121a3a");
    sky.addColorStop(0.72,"#1a2340");
    sky.addColorStop(1,"#262a3a");
    ctx.fillStyle=sky; 
    ctx.fillRect(0,0,w,h);

    // moon
    ctx.fillStyle="rgba(255,245,220,.22)";
    ctx.beginPath(); ctx.ellipse(w*0.14,h*0.16,110,90,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="rgba(255,245,220,.68)";
    ctx.beginPath(); ctx.ellipse(w*0.15,h*0.15,42,36,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="rgba(0,0,0,.08)";
    ctx.beginPath(); ctx.ellipse(w*0.145,h*0.145,10,8,0,0,Math.PI*2); ctx.fill();

    // stars twinkle
    for(let i=0;i<140;i++){
      const x=(i*73)%w;
      const y=(i*41)%Math.floor(h*0.42);
      const tw=0.35+(Math.sin(t*2+i)*0.5+0.5)*0.55;
      ctx.globalAlpha=0.12+tw*0.55;
      ctx.fillStyle="rgba(255,255,255,.95)";
      ctx.fillRect(x,y,2,2);
      if(i%9===0) ctx.fillRect(x+2,y+1,1,1);
    }
    ctx.globalAlpha=1;

    // mountains + treeline
    ctx.fillStyle="rgba(10,15,30,.55)";
    ctx.beginPath();
    ctx.moveTo(0,h*0.40);
    ctx.quadraticCurveTo(w*0.22,h*0.28,w*0.46,h*0.38);
    ctx.quadraticCurveTo(w*0.72,h*0.22,w,h*0.34);
    ctx.lineTo(w,h*0.52); ctx.lineTo(0,h*0.52);
    ctx.closePath(); ctx.fill();

    ctx.fillStyle="rgba(10,25,22,.65)";
    ctx.beginPath();
    ctx.moveTo(0,h*0.48);
    for(let xx=0;xx<=w;xx+=70){
      ctx.quadraticCurveTo(xx+35,h*0.44+Math.sin(t*0.2+xx*0.02)*8,xx+70,h*0.48);
    }
    ctx.lineTo(w,h*0.62); ctx.lineTo(0,h*0.62);
    ctx.closePath(); ctx.fill();

    // lake
    const lake=ctx.createLinearGradient(0,h*0.50,0,h*0.66);
    lake.addColorStop(0,"rgba(40,70,80,.40)");
    lake.addColorStop(1,"rgba(20,40,50,.32)");
    ctx.fillStyle=lake; 
    ctx.fillRect(0,h*0.50,w,h*0.18);

    // moon shimmer
    for(let i=0;i<70;i++){
      const x=(i*43)%w;
      const y=h*0.54+((i*29)%70);
      ctx.globalAlpha=0.05+(Math.sin(t*1.8+i)*0.5+0.5)*0.10;
      ctx.fillStyle="rgba(255,245,220,.10)";
      ctx.fillRect(x,y,26,1);
    }
    ctx.globalAlpha=1;

    // sky-flight silhouette (dragon + üç´ shrinking into distance)
    if(skyFlight.active){
      const ss = skyFlight.scale;
      const sx = skyFlight.x, sy = skyFlight.y;
      const wv = Math.sin(t*6)*3*ss;

      // faint trail
      ctx.globalAlpha = 0.10;
      ctx.strokeStyle = "rgba(255,220,140,.55)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(sx-50*ss, sy+10*ss);
      ctx.quadraticCurveTo(sx-10*ss, sy-10*ss, sx+30*ss, sy+2*ss);
      ctx.stroke();
      ctx.globalAlpha = 1;

      // dragon body
      ctx.strokeStyle = "rgba(180,40,60,.90)";
      ctx.lineWidth = Math.max(2, 6*ss);
      ctx.beginPath();
      ctx.moveTo(sx-60*ss, sy+10*ss+wv);
      ctx.bezierCurveTo(sx-20*ss, sy-10*ss-wv, sx+10*ss, sy+14*ss+wv, sx+50*ss, sy-6*ss-wv);
      ctx.stroke();

      // head
      ctx.fillStyle = "rgba(180,40,60,.95)";
      ctx.beginPath();
      ctx.ellipse(sx+54*ss, sy-10*ss-wv, 10*ss, 7*ss, 0, 0, Math.PI*2);
      ctx.fill();

      // üç´ passenger
      ctx.fillStyle = "rgba(110,60,40,.95)";
      ctx.beginPath();
      ctx.ellipse(sx+20*ss, sy+2*ss+wv*0.5, 6*ss, 6*ss, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "rgba(255,220,140,.22)";
      ctx.beginPath();
      ctx.ellipse(sx+20*ss, sy+2*ss+wv*0.5, 12*ss, 10*ss, 0, 0, Math.PI*2);
      ctx.fill();
    }

    // vignette
    const vg=ctx.createRadialGradient(w*0.5,h*0.6,80,w*0.5,h*0.6,Math.max(w,h)*0.75);
    vg.addColorStop(0,"rgba(0,0,0,0)");
    vg.addColorStop(1,"rgba(0,0,0,.32)");
    ctx.fillStyle=vg; 
    ctx.fillRect(0,0,w,h);
  }


  // Town + lanterns (world coords)
  function drawTown(t){
    const W=world.w, H=world.h;

    // grass base (night)
    ctx.fillStyle="#2c5a3c";
    ctx.fillRect(0,yardTop,W,H-yardTop);

    // grass texture + wind
    for(let y=yardTop;y<H;y+=8){
      for(let x=0;x<W;x+=22){
        const sway=Math.sin(t*1.4+x*0.02+y*0.03)*2;
        ctx.fillStyle="rgba(0,0,0,.10)";
        ctx.fillRect(x+(y%16?8:0), y+sway, 14, 2);
        ctx.fillStyle="rgba(255,255,255,.04)";
        ctx.fillRect(x+3, y+sway+3, 10, 1);
      }
    }

    // subtle blue tint wash
    ctx.fillStyle="rgba(20,30,55,.18)";
    ctx.fillRect(0, yardTop, W, H-yardTop);

    // fence
    ctx.fillStyle="rgba(0,0,0,.18)";
    ctx.fillRect(0, fenceY+18, W, 6);
    roundRect(0,fenceY,W,26,0,"rgba(130,85,55,.78)","rgba(0,0,0,.30)");
    for(let x=0;x<W;x+=18){
      roundRect(x+4,fenceY-12,10,34,3,"rgba(150,95,65,.82)","rgba(0,0,0,.30)");
    }

    // Lantern helper
    function lantern(x,y,ph,scale=1){
      const glow=0.18+(Math.sin(t*1.9+ph)+1)*0.06;
      roundRect(x-12*scale,y-12*scale,24*scale,28*scale,10*scale,"rgba(180,40,60,.95)","rgba(0,0,0,.30)");
      ctx.fillStyle=`rgba(255,220,140,${glow+0.10})`;
      ctx.beginPath(); ctx.ellipse(x,y+4*scale,18*scale,14*scale,0,0,Math.PI*2); ctx.fill();
      const tass=Math.sin(t*3+ph)*2*scale;
      ctx.strokeStyle="rgba(255,200,60,.70)";
      ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(x,y+18*scale); ctx.lineTo(x+tass,y+30*scale); ctx.stroke();

      const rg=ctx.createRadialGradient(x,y+40*scale,10,x,y+40*scale,130*scale);
      rg.addColorStop(0,"rgba(255,220,140,.22)");
      rg.addColorStop(1,"rgba(255,220,140,0)");
      ctx.fillStyle=rg;
      ctx.beginPath(); ctx.ellipse(x,y+70*scale,160*scale,90*scale,0,0,Math.PI*2); ctx.fill();
    }
    function lanternString(x0,y0,x1,y1,count,ph){
      ctx.strokeStyle="rgba(255,220,140,.22)";
      ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.stroke();
      for(let i=0;i<count;i++){
        const u=(i+1)/(count+1);
        const x=x0+(x1-x0)*u;
        const y=y0+(y1-y0)*u + Math.sin(t*1.2+u*6+ph)*2;
        lantern(x,y,ph+i*0.7,0.85);
      }
    }

    // stage glow ring
    ctx.fillStyle="rgba(255,220,140,.08)";
    ctx.beginPath(); ctx.arc(stage.x,stage.y,132,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="rgba(180,40,60,.10)";
    ctx.beginPath(); ctx.arc(stage.x,stage.y,92,0,Math.PI*2); ctx.fill();

    // stage banner (waving)
    const wave=Math.sin(t*2)*3;
    roundRect(stage.x-140, stage.y-200+wave, 280, 44, 12, "rgba(180,40,60,.90)", "rgba(0,0,0,.30)");
    ctx.fillStyle="rgba(255,220,140,.90)";
    ctx.font="20px system-ui";
    ctx.fillText("Êñ∞Âπ¥Âø´‰πê", stage.x-60, stage.y-170+wave);

    // lanterns around stage + town
    lantern(stage.x-180, stage.y-50, 0, 1);
    lantern(stage.x+190, stage.y-44, 2, 1);
    lantern(W*0.14, yardTop+70, 3.1, 0.9);
    lantern(W*0.30, yardTop+90, 4.4, 0.8);
    lantern(W*0.76, yardTop+85, 5.2, 0.85);
    lantern(W*0.56, yardTop+110, 6.0, 0.8);
    lanternString(W*0.08, fenceY-40, W*0.46, fenceY-70, 6, 1.3);
    lanternString(W*0.52, fenceY-70, W*0.92, fenceY-40, 6, 2.1);

    // bushes
    function bush(x,y,scale){
      const sway=Math.sin(t*1.2+x*0.01)*3;
      ctx.fillStyle="rgba(0,0,0,.18)";
      ctx.beginPath(); ctx.ellipse(x,y+42*scale,44*scale,10*scale,0,0,Math.PI*2); ctx.fill();
      roundRect(x-52*scale,y-18*scale+sway,104*scale,78*scale,26*scale,"rgba(30,90,55,.85)","rgba(0,0,0,.30)");
      roundRect(x-40*scale,y-10*scale+sway,80*scale,56*scale,22*scale,"rgba(70,140,80,.30)",null);
    }
    bush(W*0.22, H*0.72, 1.0);
    bush(W*0.70, H*0.72, 1.05);
  }

  // Crowd drawing
  function drawPerson(p, t){
    const x=p.x, y=p.y;
    const bob=Math.sin(p.t + t*2.2)*1.2;

    ctx.fillStyle="rgba(0,0,0,.22)";
    ctx.beginPath(); ctx.ellipse(x, y+14, 16, 5, 0,0,Math.PI*2); ctx.fill();

    ctx.strokeStyle="rgba(0,0,0,.28)";
    ctx.lineWidth=3;
    ctx.beginPath();
    ctx.moveTo(x-4, y+6); ctx.lineTo(x-4, y+14);
    ctx.moveTo(x+4, y+6); ctx.lineTo(x+4, y+14);
    ctx.stroke();

    roundRect(x-11, y-10+bob, 22, 22, 6, p.col, "rgba(0,0,0,.28)");
    ctx.fillStyle="rgba(255,220,140,.20)";
    ctx.fillRect(x-9, y+3+bob, 18, 3);

    ctx.fillStyle="rgba(255,220,190,.95)";
    ctx.beginPath(); ctx.ellipse(x, y-20+bob, 10, 10, 0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle="rgba(0,0,0,.22)"; ctx.lineWidth=1; ctx.stroke();

    roundRect(x-10, y-28+bob, 20, 10, 5, "rgba(40,20,30,.55)", "rgba(0,0,0,.10)");

    ctx.fillStyle="rgba(40,20,30,.70)";
    ctx.beginPath(); ctx.ellipse(x-3, y-20+bob, 1.6, 1.6, 0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(x+3, y-20+bob, 1.6, 1.6, 0,0,Math.PI*2); ctx.fill();
  }

  function drawZodiac(z, t){
    const x=z.x, y=z.y;
    const bob=Math.sin(t*2.1 + z.t)*3;

    ctx.fillStyle="rgba(0,0,0,.22)";
    ctx.beginPath(); ctx.ellipse(x, y+14, 16, 5, 0,0,Math.PI*2); ctx.fill();

    roundRect(x-14, y-10+bob, 28, 18, 7, "rgba(255,255,255,.85)", "rgba(0,0,0,.28)");
    roundRect(x-10, y-24+bob, 20, 14, 7, "rgba(255,255,255,.85)", "rgba(0,0,0,.28)");

    ctx.fillStyle="rgba(40,20,30,.70)";
    ctx.beginPath(); ctx.ellipse(x-4, y-18+bob, 1.8, 1.8, 0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(x+4, y-18+bob, 1.8, 1.8, 0,0,Math.PI*2); ctx.fill();

    roundRect(x-8, y-6+bob, 16, 6, 4, "rgba(180,40,60,.85)", "rgba(0,0,0,.18)");
  }

  // Potato + show characters
  function drawPotato(t){
    const x=player.x, y=player.y;
    const step=Math.sin(player.walk)*1.1;
    const hairSway=Math.sin(t*2.2+player.walk*0.15)*3;

    ctx.fillStyle="rgba(0,0,0,.22)";
    ctx.beginPath(); ctx.ellipse(x,y+18,22,7,0,0,Math.PI*2); ctx.fill();

    ctx.strokeStyle="rgba(0,0,0,.28)";
    ctx.lineWidth=3;
    ctx.beginPath();
    ctx.moveTo(x-6,y+10); ctx.lineTo(x-6,y+18+step);
    ctx.moveTo(x+6,y+10); ctx.lineTo(x+6,y+18-step);
    ctx.stroke();

    ctx.fillStyle="rgba(225,175,120,.95)";
    ctx.beginPath(); ctx.ellipse(x,y,24,28,0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle="rgba(0,0,0,.28)"; ctx.lineWidth=1; ctx.stroke();

    roundRect(x-22,y-2,44,32,14,"rgba(180,40,60,.95)","rgba(0,0,0,.28)");
    ctx.fillStyle="rgba(255,220,140,.65)";
    ctx.fillRect(x-18,y+7,36,3);

    ctx.strokeStyle="rgba(0,0,0,.26)";
    ctx.lineWidth=3;
    ctx.beginPath();
    ctx.moveTo(x-19,y+2); ctx.lineTo(x-28,y+7+step);
    ctx.moveTo(x+19,y+2); ctx.lineTo(x+28,y+7-step);
    ctx.stroke();

    ctx.fillStyle="rgba(70,40,30,.78)";
    ctx.beginPath(); ctx.ellipse(x+hairSway*0.3,y-18,22,16,0,0,Math.PI*2); ctx.fill();
    roundRect(x-23+hairSway*0.5,y-18,12,38,8,"rgba(55,30,22,.78)","rgba(0,0,0,.10)");
    roundRect(x+11+hairSway*0.5,y-18,12,38,8,"rgba(55,30,22,.78)","rgba(0,0,0,.10)");

    ctx.fillStyle="rgba(40,20,30,.78)";
    ctx.beginPath(); ctx.ellipse(x-6,y-6,2.2,2.2,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(x+6,y-6,2.2,2.2,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="rgba(0,0,0,.18)";
    ctx.beginPath(); ctx.ellipse(x,y-1,5,2,0,0,Math.PI*2); ctx.fill();
  }

  function drawLion(t){
    if(!lion.visible) return;
    const x=lion.x, y=lion.y;
    const wig=Math.sin(t*6)*6;
    const hop=Math.abs(Math.sin(t*4))*10;

    ctx.fillStyle="rgba(0,0,0,.26)";
    ctx.beginPath(); ctx.ellipse(x,y+44,70,16,0,0,Math.PI*2); ctx.fill();

    roundRect(x-74,y-10+hop,150,74,32,"rgba(255,255,255,.86)","rgba(0,0,0,.30)");
    roundRect(x-62,y+2+hop,126,18,12,"rgba(180,40,60,.78)","rgba(0,0,0,.18)");
    ctx.fillStyle="rgba(255,220,140,.55)";
    ctx.fillRect(x-44,y+10+hop,88,4);

    roundRect(x-82+wig,y-52+hop,90,74,26,"rgba(180,40,60,.95)","rgba(0,0,0,.30)");
    roundRect(x-70+wig,y-40+hop,66,48,22,"rgba(255,255,255,.92)","rgba(0,0,0,.22)");

    ctx.fillStyle="rgba(40,20,30,.78)";
    ctx.beginPath(); ctx.ellipse(x-48+wig,y-22+hop,6,6,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(x-26+wig,y-22+hop,6,6,0,0,Math.PI*2); ctx.fill();
  }

  function drawChocolate(t){
    if(!choco.visible) return;
    const x=choco.x, y=choco.y + choco.yOff;
    ctx.fillStyle="rgba(0,0,0,.22)";
    ctx.beginPath(); ctx.ellipse(x,y+18,18,6,0,0,Math.PI*2); ctx.fill();
    roundRect(x-16,y-18,32,40,12,"rgba(180,40,60,.95)","rgba(0,0,0,.30)");
    ctx.fillStyle="rgba(110,60,40,.90)";
    ctx.beginPath(); ctx.ellipse(x,y-26,14,14,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="rgba(40,20,30,.55)";
    ctx.beginPath(); ctx.ellipse(x,y-32,14,10,0,0,Math.PI*2); ctx.fill();
  }

  function drawDragon(t){
    if(!dragon.visible) return;
    const x=dragon.x, y=dragon.y;
    const wave=Math.sin(t*6)*10;
    ctx.strokeStyle="rgba(180,40,60,.90)";
    ctx.lineWidth=10;
    ctx.beginPath();
    ctx.moveTo(x-120,y+wave);
    ctx.bezierCurveTo(x-40,y-30-wave,x+40,y+30+wave,x+120,y-wave);
    ctx.stroke();

    ctx.strokeStyle="rgba(255,220,140,.75)";
    ctx.lineWidth=6;
    ctx.beginPath();
    ctx.moveTo(x-110,y+wave);
    ctx.bezierCurveTo(x-36,y-22-wave,x+36,y+22+wave,x+110,y-wave);
    ctx.stroke();

    roundRect(x+108,y-18-wave,44,30,14,"rgba(180,40,60,.95)","rgba(0,0,0,.30)");
  }

  function drawDroppedEnvelope(){
    if(!droppedEnvelope.active) return;
    const x=droppedEnvelope.x, y=droppedEnvelope.y;

    ctx.fillStyle="rgba(0,0,0,.22)";
    ctx.beginPath(); ctx.ellipse(x,y+10,18,6,0,0,Math.PI*2); ctx.fill();

    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(droppedEnvelope.rot);

    roundRect(-16,-14,32,22,6,"rgba(180,40,60,.98)","rgba(0,0,0,.30)");
    ctx.fillStyle="rgba(255,255,255,.18)";
    ctx.beginPath(); ctx.moveTo(-16,-14); ctx.lineTo(0,0); ctx.lineTo(16,-14); ctx.closePath(); ctx.fill();
    ctx.fillStyle="rgba(255,220,140,.90)";
    ctx.beginPath(); ctx.ellipse(0,2,5,5,0,0,Math.PI*2); ctx.fill();

    ctx.restore();
  }

  function drawParticles(){
    for(const f of fireworks){ ctx.fillStyle=f.col; ctx.fillRect(f.x,f.y,3,3); }
    for(const c of confetti){ ctx.fillStyle=c.col; ctx.fillRect(c.x,c.y,4,2); }
  }

  function drawBubble(){
    if(!bubble.on) return;
    const w=canvas.clientWidth, h=canvas.clientHeight;
    const shown=bubble.full.slice(0, Math.floor(bubble.reveal));
    const maxChars=56;
    const words=shown.split(/\s+/);
    const lines=[]; let line="";
    for(const w0 of words){
      if(!line) line=w0;
      else if((line+" "+w0).length<=maxChars) line+=" "+w0;
      else { lines.push(line); line=w0; }
    }
    if(line) lines.push(line);

    const bx=Math.max(14, Math.min(w-380, (player.x-cam.x)*ZOOM - 180));
    const by=Math.max(14, Math.min(h-140, (player.y-cam.y)*ZOOM - 140));
    const bw=380;
    const bh=18 + Math.min(5, lines.length)*18 + 12;

    roundRect(bx,by,bw,bh,14,"rgba(255,255,255,.86)","rgba(0,0,0,.12)");
    ctx.fillStyle="rgba(40,20,30,.90)";
    ctx.font="14px system-ui";
    ctx.fillText(bubble.who + ":", bx+14, by+22);
    for(let i=0;i<Math.min(5, lines.length);i++){
      ctx.fillText(lines[i], bx+14, by+42+i*18);
    }
  }

  function updateCrowd(dt){
    if(act.phase!=="free") return;
    for(const p of crowd){
      p.wait -= dt;
      if(p.wait<=0){
        p.wait = rnd(0.6,2.0);
        const a = rnd(0,Math.PI*2);
        p.vx = Math.cos(a)*rnd(10,28);
        p.vy = Math.sin(a)*rnd(10,28);
      }
      p.x += p.vx*dt;
      p.y += p.vy*dt;
      p.x = clamp(p.x, 110, world.w-110);
      p.y = clamp(p.y, yardTop+20, world.h-105);
      p.vx *= (1 - dt*1.6);
      p.vy *= (1 - dt*1.6);
    }
  }

  function updatePlayer(dt){
    if(act.phase==="lion" || act.phase==="reveal") return;
    if(envelopeOpen) return;

    const d=desiredDir();
    const len=Math.hypot(d.dx,d.dy)||1;
    const dx=(d.dx/len)*player.spd;
    const dy=(d.dy/len)*player.spd;
    player.x+=dx*dt; player.y+=dy*dt;

    player.x=clamp(player.x, 85, world.w-85);
    player.y=clamp(player.y, yardTop+20, world.h-105);

    if(Math.abs(dx)+Math.abs(dy)>1) player.walk += dt*10;
  }

  function updateAct(dt, t){
    act.t += dt;

    if(act.phase==="lion"){
      if(Math.random()<0.06) spawnFirework(rnd(world.w*0.35, world.w*0.85), rnd(80, 190));
      if(act.t>6.5){
        act.phase="reveal"; act.t=0;
        choco.visible=true; choco.x=stage.x+20; choco.y=stage.y-10; choco.yOff=30;
        say("üç´","Happy year of the horse!!!",6.0,16);
        setStatus("A surprise‚Ä¶!");
      }
    } else if(act.phase==="reveal"){
      choco.yOff = Math.max(-10, choco.yOff - dt*120);
      if(act.t>2.0){
        act.phase="dragon"; act.t=0;
        dragon.visible=true; dragon.x=-260; dragon.y=170; dragon.carrying=false;
      }
    } else if(act.phase==="dragon"){
      dragon.x += dragon.vx*dt;
      if(!dragon.carrying && dragon.x > stage.x - 40) dragon.carrying = true;
      if(dragon.carrying){
        choco.x = dragon.x + 110;
        choco.y = dragon.y + 10;
        choco.yOff = Math.sin(t*10)*4;
        if(!droppedEnvelope.active && dragon.x > stage.x + 120){
          spawnDroppedEnvelope(dragon.x + 70, dragon.y + 30);
        }
      }
      if(Math.random()<0.08) spawnFirework(rnd(world.w*0.35, world.w*0.85), rnd(70, 180));
      if(dragon.x > world.w + 260){
        // launch a tiny sky silhouette that keeps flying into the distance
        skyFlight.active = true;
        skyFlight.vx = 60;
        skyFlight.scale = 0.6;
        skyFlight.t = 0;
        // start near the upper-right of the screen so it always shows
        skyFlight.x = canvas.clientWidth * 0.70;
        skyFlight.y = canvas.clientHeight * 0.22;
        skyFlight.vx = 140;
        skyFlight.vy = -55;
        skyFlight.scale = 1.0;

        act.phase="finale"; act.t=0;
        dragon.visible=false; choco.visible=false;
        burstConfetti(stage.x, stage.y+30);
        say("Festival","Êñ∞Âπ¥Âø´‰πêÔºÅÊÅ≠ÂñúÂèëË¥¢ÔºÅ",10.0,14);
        setStatus("Happy New Year! ‚Äî Talk at the stage to replay!");
        setAct("Act: Finale");
      }
    }
  }

  function updateParticles(dt){
    for(let i=fireworks.length-1;i>=0;i--){
      const f=fireworks[i];
      f.life -= dt;
      f.vy += 60*dt;
      f.x += f.vx*dt;
      f.y += f.vy*dt;
      if(f.life<=0) fireworks.splice(i,1);
    }
    for(let i=confetti.length-1;i>=0;i--){
      const c=confetti[i];
      c.life -= dt;
      c.vy += 140*dt;
      c.x += c.vx*dt;
      c.y += c.vy*dt;
      c.vx *= (1 - dt*0.6);
      if(c.life<=0) confetti.splice(i,1);
    }
  }

  function updateBubble(dt){
    if(!bubble.on) return;
    if(!bubble.done){
      bubble.reveal += dt*bubble.cps;
      if(bubble.reveal >= bubble.full.length){
        bubble.reveal = bubble.full.length; bubble.done = true;
      }
    }
    bubble.ttl -= dt;
    if(bubble.ttl <= 0) bubble.on=false;
  }

  function updateSkyFlight(dt){
    if(!skyFlight.active) return;
    skyFlight.t += dt;

    // steady glide across sky
    skyFlight.x += skyFlight.vx * dt;
    skyFlight.y += Math.sin(skyFlight.t * 2) * 8 * dt;

    // wrap around screen instead of disappearing
    if(skyFlight.x > canvas.clientWidth + 100){
      skyFlight.x = -100;
    }
  }

  function updateCamera(){
    const vw=canvas.clientWidth, vh=canvas.clientHeight;
    const viewW=vw/ZOOM, viewH=vh/ZOOM;
    const targetX=clamp(player.x - viewW/2, 0, world.w - viewW);
    const targetY=clamp(player.y - viewH/2, 0, world.h - viewH);
    cam.x += (targetX - cam.x)*0.10;
    cam.y += (targetY - cam.y)*0.10;
  }

  function render(t){
    drawBackground(t);

    ctx.save();
    ctx.scale(ZOOM,ZOOM);
    ctx.translate(-cam.x, -cam.y);

    drawTown(t);

    for(const p of crowd){
      if(p.kind==="person") drawPerson(p,t);
      else drawZodiac(p,t);
    }

    drawLion(t);
    drawChocolate(t);
    drawDragon(t);
    drawDroppedEnvelope();
    drawPotato(t);
    drawParticles();

    ctx.restore();
    drawBubble();

    if(!envelopeOpen && droppedEnvelope.active && dist(player.x,player.y,droppedEnvelope.x,droppedEnvelope.y) < 90){
      const ex=(droppedEnvelope.x - cam.x)*ZOOM;
      const ey=(droppedEnvelope.y - cam.y)*ZOOM;
      roundRect(ex-120, ey-58, 240, 34, 12, "rgba(255,255,255,.82)", "rgba(0,0,0,.10)");
      ctx.fillStyle="rgba(40,20,30,.85)";
      ctx.font="14px system-ui";
      ctx.fillText("A red envelope fell‚Ä¶ (Talk)", ex-98, ey-34);
    }
  }

  let last=performance.now();
  let time=0;
  function tick(now){
    const dt=Math.min(0.033, (now-last)/1000);
    last=now; time += dt;

    updateCrowd(dt);
    updateBubble(dt);
    updatePlayer(dt);
    updateAct(dt, time);
    updateParticles(dt);
    updateDroppedEnvelope(dt);
    updateCamera();
    updateSkyFlight(dt);
    render(time);

    requestAnimationFrame(tick);
  }

  function start(){
    started=true;
    document.getElementById("loading").classList.add("hidden");
    setAct("Act: Festival");
    setStatus("Walk to the center stage and press Talk (E) to start the Lion Dance.");
    requestAnimationFrame(tick);
  }

  document.getElementById("startBtn").addEventListener("click", ()=>{
    initSfx();
    startBackgroundMusic();
    start();
  });

})();
</script>
</body>
</html>
